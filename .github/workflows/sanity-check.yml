name: Helm Chart Validation
on: [push, pull_request]

jobs:
  validate-chart:
    runs-on: ubuntu-latest
    steps:
      # 1. Check out your code
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          repository: wgcma/nginx-helm-dev
          path: ws

      # 2. Install Helm on runner
      - name: Set up Chart Testing
        uses: helm/chart-testing-action@v2.6.1

      # 3. Run the Lint command
      # Replace 'charts/my-app' with the path to your chart folder
      - name: Lint Helm Chart
        run: |
          helm lint ./ws/infra

      # 4. "Hello World" - Dry run to see if it renders
      - name: Test Template Rendering
        run: |
          helm template test-release-${{ github.run_id }} ./ws/infra --debug

      - name: Setup Kubeconform
        run: |
          wget https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz
          tar xf kubeconform-linux-amd64.tar.gz
          sudo cp kubeconform /usr/local/bin

      - name: Validate with Kubeconform
        run: |
          # 1. 'helm template' generates the YAML
          # 2. '|' (the pipe) sends that YAML to kubeconform
          # 3. '-summary' gives a nice output of what passed/failed
          # 4. '-strict' ensures no unknown fields are allowed
          helm template my-test-release ./infra/infra | kubeconform -summary -strict
